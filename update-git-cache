#!/bin/bash

# Update git cache entries from local repos or remote URLs

CACHE_DIR="${GIT_CLONE_CACHE_DIR:=$HOME/.git-clone-cache}"
mkdir -p "$CACHE_DIR"

if [[ $# -eq 0 ]]; then
    echo "Usage: update-git-cache /path/to/repo [/path/to/repo2 ...] [https://url ...]" >&2
    exit 1
fi

for arg in "$@"; do
    if [[ -d "$arg/.git" ]]; then
        # It's a local repo, extract origin URL
        url=$(git -C "$arg" remote get-url origin 2>/dev/null)
        if [[ -z "$url" ]]; then
            echo "WARNING: No origin remote in $arg, skipping" >&2
            continue
        fi
        source="local repo: $arg"
    else
        # Assume it's a URL
        url="$arg"
        source="URL"
    fi

    # Compute cache key (same as wrapper)
    cache_key=$(printf '%s' "$url" | sha256sum | cut -d' ' -f1)
    cache_mirror="$CACHE_DIR/$cache_key"

    # Check if cached
    if [[ ! -d "$cache_mirror" ]]; then
        echo "WARNING: Not cached: $url ($source)" >&2
        echo "  (Run: populate-git-cache to cache this repo)" >&2
        continue
    fi

    echo "Updating: $url"
    echo "Running: git -C $cache_mirror fetch --all"
    if git -C "$cache_mirror" fetch --all; then
        echo "  -> OK"
    else
        echo "ERROR: Failed to update cache for $url" >&2
    fi
done

echo "Done."
