#!/bin/bash

# Wrapper to intercept git clone and use local mirror cache

# Find real git binary (skip this wrapper)
REAL_GIT=$(which -a git 2>/dev/null | grep -v "$(dirname "$0")" | head -1)

if [[ -z "$REAL_GIT" ]] || [[ ! -x "$REAL_GIT" ]]; then
    echo "Error: Could not find git binary" >&2
    exit 1
fi

# Check if "clone" is in the arguments
clone_found=0
for arg in "$@"; do
    if [[ "$arg" == "clone" ]]; then
        clone_found=1
        break
    fi
done

# If no clone, pass through
if [[ $clone_found -eq 0 ]]; then
    exec "$REAL_GIT" "$@"
fi

# Extract URL from arguments after clone
url=""
skip_next=0
after_clone=0
for arg in "$@"; do
    if [[ "$arg" == "clone" ]]; then
        after_clone=1
        continue
    fi

    if [[ $after_clone -eq 0 ]]; then
        continue
    fi

    if [[ $skip_next -eq 1 ]]; then
        skip_next=0
        continue
    fi

    # Flags that take an argument
    if [[ "$arg" =~ ^(--depth|--single-branch|--branch)$ ]]; then
        skip_next=1
        continue
    fi

    # Skip other flags
    if [[ "$arg" =~ ^- ]]; then
        continue
    fi

    # First non-option argument is the URL
    url="$arg"
    break
done

# If no URL found or it's a local path (determine by checking if the path exists locally), pass through
if [[ -z "$url" ]] || [[ -d "$url" ]] || [[ -f "$url" ]]; then
    echo "[git-clone-cache] No remote URL detected, passing through" >&2
    exec "$REAL_GIT" "$@"
fi

# Determine cache directory (with env var override)
CACHE_DIR="${GIT_CLONE_CACHE_DIR:=$HOME/.git-clone-cache}"
mkdir -p "$CACHE_DIR"

# Compute stable cache key from URL
echo "[git-clone-cache] Clone URL: $url" >&2
CACHE_KEY=$(printf '%s' "$url" | sha256sum | cut -d' ' -f1)
echo "[git-clone-cache] Cache key (sha256): $CACHE_KEY" >&2
CACHE_MIRROR="$CACHE_DIR/$CACHE_KEY"

# Initialize cache if missing
if [[ ! -d "$CACHE_MIRROR" ]]; then
    echo "[git-clone-cache] Initializing cache: $url" >&2
    echo "[git-clone-cache] $REAL_GIT clone --mirror $url $CACHE_MIRROR" >&2
    "$REAL_GIT" clone --mirror "$url" "$CACHE_MIRROR" || {
        echo "[git-clone-cache] ERROR: Failed to clone to cache" >&2
        exit 1
    }
else
    # Update existing cache
    echo "[git-clone-cache] Updating cache mirror" >&2
    echo "[git-clone-cache] $REAL_GIT -C $CACHE_MIRROR fetch --all" >&2
    if ! "$REAL_GIT" -C "$CACHE_MIRROR" fetch --all >/dev/null 2>&1; then
        echo "[git-clone-cache] WARNING: Failed to update cache, proceeding anyway" >&2
    fi
fi

# Insert cache flags after "clone" in the original arg list
declare -a new_args=()
found_clone=0
for arg in "$@"; do
    new_args+=("$arg")
    if [[ "$arg" == "clone" ]] && [[ $found_clone -eq 0 ]]; then
        found_clone=1
        new_args+=("--reference" "$CACHE_MIRROR")
    fi
done

echo "[git-clone-cache] Cloning from local cache" >&2
echo "[git-clone-cache] $REAL_GIT ${new_args[*]}" >&2
exec "$REAL_GIT" "${new_args[@]}"
